<!DOCTYPE html>
<html>
<head> 
    <title>Foresta con Sole</title> 
    <style>
        body{
            margin: 0;
            overflow: hidden;
        }
        
        #stats {  /* Align stats top-left */
            position: absolute;
            left: 0px;
            top: 0px;
        }
    </style> 
</head>
<body> 
    <!-- JavaScript libraries -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/three.js/r67/three.min.js"></script> 
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/stats.js/r11/Stats.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5/dat.gui.min.js"></script>
    <script src="assets/libs/TrackballControls.js"></script>
    
    <!-- Javascript code that runs our Three.js examples --> 
    <script>
        // Returns a random number between min and max
        function getRandomArbitary(min, max)
        {
            return Math.random() * (max - min) + min;
        }
        
        // once everything is loaded, we run our Three.js stuff.
        $(function () 
        {
            var stats = initStats();
            
            // create a scene, that will hold all our elements such as objects, cameras and lights.
            var scene = new THREE.Scene();
            
            // create a camera, which defines where we're looking at.
            var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // create a render and set the size
            var renderer = new THREE.WebGLRenderer();
            
            var trackballControls = new THREE.TrackballControls(camera);
            
            renderer.setClearColor(new THREE.Color(0xEEEEEE));
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMapEnabled = true;
            
            // create the ground plane
            var planeGeometry = new THREE.PlaneGeometry(100,100,20,20);
            var planeMaterial =  new THREE.MeshLambertMaterial({color: 0x00cc00});
            var plane = new THREE.Mesh(planeGeometry,planeMaterial);
            plane.receiveShadow = true;
            planeMaterial.side = THREE.DoubleSide;
            
            // rotate and position the plane
            plane.rotation.x=-0.5*Math.PI;
            
            // add the plane to the scene
            scene.add(plane);
            
            function generateTree()
            {
                // create a cylinder
                var cylinderGeometry = new THREE.CylinderGeometry(2,2,10,20,20,false);
                var cylinderMaterial = new THREE.MeshLambertMaterial({color: 0x663300});
                var cylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
                // position the cylinder
                cylinder.position.set(0,5,0);
                cylinder.castShadow = true;
                
                var sphereRadius = 7;
                var sphereGeometry = new THREE.SphereGeometry(sphereRadius,20,20);
                var sphereMaterial = new THREE.MeshLambertMaterial({color: 0x334400});
                var sphere = new THREE.Mesh(sphereGeometry,sphereMaterial);
                // position the sphere
                sphere.position.set(0,15,0);
                sphere.castShadow = true;
                
                var appleGeometry = new THREE.SphereGeometry(1,5,5);
                var appleMaterial = new THREE.MeshLambertMaterial({color: 0xFF0000});
                var apple = new THREE.Mesh(appleGeometry,appleMaterial);
                apple.castShadow = true;
                
                var newApple;
                for (var i = 0; i<10; i++) {
                    newApple = apple.clone();
                    randHor = getRandomArbitary(0, 2*Math.PI);
                    randVer = getRandomArbitary(0, Math.PI);
                    appleX = sphereRadius * Math.cos(randHor) * Math.sin(randVer);
                    appleY = sphereRadius * Math.sin(randHor) * Math.sin(randVer);
                    appleZ = sphereRadius * Math.cos(randVer);
                    newApple.position.set(appleX,appleY,appleZ);
                    sphere.add(newApple);
                }
                
                var tree = new THREE.Object3D();
                tree.add(cylinder);
                tree.add(sphere);
                
                return tree;
            }            
            
            var newTree;
            for (var i = 0; i<15; i++) {
                newTree = generateTree();
                randHor = getRandomArbitary(-35, 35);
                randVer = getRandomArbitary(-35, 35);
                newTree.position.x = randHor;
                newTree.position.z = randVer;
                newTree.castShadow = true;
                scene.add(newTree);
            }
            
            // position and point the camera to the center of the scene
            camera.position.set(100,100,100);
            camera.up = new THREE.Vector3(0,1,0);
            camera.lookAt(scene.position);
            
            // add subtle ambient lighting
            var ambiColor = "#1c1c1c";
            var ambientLight = new THREE.AmbientLight(ambiColor);
            scene.add(ambientLight);
            
            // add axis helper
            var axisHelper = new THREE.AxisHelper(3);
            scene.add(axisHelper);
            
            var pointColor = "#ff5808";
            var directionalLight = new THREE.DirectionalLight(pointColor);
            directionalLight.castShadow = true;
            directionalLight.shadowCameraNear = 0;
            directionalLight.shadowCameraFar = 150;
            directionalLight.shadowCameraLeft = -50;
            directionalLight.shadowCameraRight = 50;
            directionalLight.shadowCameraTop = 50;
            directionalLight.shadowCameraBottom = -50;
            directionalLight.intensity = 1;
            directionalLight.shadowMapHeight = 512;
            directionalLight.shadowMapWidth = 512;
            
            scene.add(directionalLight);
            
            // add a small sphere simulating the pointlight
            var sphereLight = new THREE.SphereGeometry(5,20,20);
            var sphereLightMaterial = new THREE.MeshBasicMaterial({color: 0xac6c25});
            var sphereLightMesh = new THREE.Mesh(sphereLight, sphereLightMaterial);
            sphereLightMesh.castShadow = false;
            
            scene.add(sphereLightMesh);
            
            // add the output of the renderer to the html element
            $('body').append(renderer.domElement);
            
            var step = 0;
            
            var controls = new function () {
                this.showAxisHelper = true;
                this.debug = false;
            };
            
            var gui = new dat.GUI();
            
            gui.add(controls, 'showAxisHelper').onChange(function (value) {
                axisHelper.visible = value;
            });
            
            gui.add(controls, 'debug').onChange(function (e) {
                directionalLight.shadowCameraVisible = e;
            });
            
            
            render();
            
            function render() {
                stats.update();
                trackballControls.update();
                
                step += 0.005;
                sphereLightMesh.position.z = 0;
                sphereLightMesh.position.y = (70 * (Math.sin(step)));
                sphereLightMesh.position.x = (70 * (Math.cos(step)));
                directionalLight.position = sphereLightMesh.position;
                
                requestAnimationFrame(render);
                renderer.render(scene, camera);
            }
            
            function initStats() {
                var stats = new Stats();
                stats.setMode(0); // 0: fps, 1: ms
                $('body').append(stats.domElement);
                return stats;
            }
        });
    </script>
</body>
</html>
